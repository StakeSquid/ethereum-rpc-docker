services:
  fantom-testnet:
    build:
      args:
        VERSION: release/1.1.3-rc.5
      context: ./fantom
      dockerfile: Dockerfile-testnet
    stop_grace_period: 3m
    environment:
      - CACHE_SIZE=${FANTOM_CACHE_SIZE:-16000}
      - IP=${IP}
    volumes:
      - "fantom-testnet-opera-pruned-traces:/datadir"
    expose:
      - "18544"
      - "44629"
    ports:
      - "44629:44629"
      - "44629:44629/udp"
    networks:
      - chains
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.fantom-testnet-opera-pruned-traces-stripprefix.stripprefix.prefixes=/fantom-testnet"
      - "traefik.http.services.fantom-testnet-opera-pruned-traces.loadbalancer.server.port=18544"
      - "traefik.http.routers.fantom-testnet-opera-pruned-traces.entrypoints=websecure"
      - "traefik.http.routers.fantom-testnet-opera-pruned-traces.tls.certresolver=myresolver"
      - "traefik.http.routers.fantom-testnet-opera-pruned-traces.rule=Host(`$DOMAIN`) && PathPrefix(`/fantom-testnet`)"
      - "traefik.http.routers.fantom-testnet-opera-pruned-traces.middlewares=fantom-testnet-opera-pruned-traces-stripprefix, ipwhitelist"

volumes:
  fantom-testnet-opera-pruned-traces:
