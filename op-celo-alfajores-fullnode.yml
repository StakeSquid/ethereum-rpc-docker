services:
  op-celo-alfajores-fullnode:
    image: us-west1-docker.pkg.dev/devopsre/celo-blockchain-public/op-geth:celo-v2.0.0-rc4
    volumes:
      - "op-celo-alfajores-fullnode:/datadir"
      - ".jwtsecret:/jwtsecret"
    ports:
      - "10955:10955"
      - "10955:10955/udp"
    expose:
      - 8545
      - 8546
      - 8551
    networks:
      - chains
    restart: always
    stop_grace_period: 5m
    environment:
      - NETWORK_NAME=alfajores
      - NODE_TYPE=full
      - OP_GETH__SYNCMODE=full
      - PORT__OP_GETH_HTTP=8545
      - PORT__OP_GETH_WS=8545
      - PORT__OP_GETH_P2P=10955
      - BEDROCK_SEQUENCER_HTTP=https://sequencer.alfajores.celo-testnet.org
      - BEDROCK_DATADIR=/datadir
      - GETH_BOOTNODES=enode://ac0f42fa46f8cc10bd02a103894d71d495537465133e7c442bc02dc76721a5f41761cc2d8c69e7ba1b33e14e28f516436864d3e0836e2dcdaf032387f72447dd@34.83.164.192:30303,enode://596002969b8b269a4fa34b4709b9600b64201e7d02e2f5f1350affd021b0cbda6ce2b913ebe24f0fb1edcf66b6c730a8a3b02cd940f4de995f73d3b290a0fc92@34.82.177.77:30303,enode://3619455064ef1ce667171bba1df80cfd4c097f018cf0205aaad496f0d509611b7c40396893d9e490ee390cd098888279e177a4d9bb09c58387bb0a6031d237f1@34.19.90.27:30303,enode://e3c54db6004a92d4ee87504f073f3234a25759b485274cc224037e3e5ee792f3b482c3f4fffcb764af6e1859a1aea9710b71e1991e32c1dee7f40352124bb182@35.233.249.87:30303,enode://674410b34fd54c8406a4f945292b96111688d4bab49aecdc34b4f1b346891f4673dcb03ed44c38ab467ef7bec0b20f6031ad88aa1d35ce1333b343d00fa19fb1@34.168.43.76:30303
    command: >
      geth
      --datadir="$BEDROCK_DATADIR"
      --http
      --http.corsdomain="*"
      --http.vhosts="*"
      --http.addr=0.0.0.0
      --http.port=8545
      --http.api=web3,debug,eth,txpool,net,engine
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8545
      --ws.origins="*"
      --ws.api=debug,eth,txpool,net,engine,web3
      --syncmode="$OP_GETH__SYNCMODE"
      --gcmode="$NODE_TYPE"
      --authrpc.vhosts="*"
      --authrpc.addr=0.0.0.0
      --authrpc.port=8551
      --authrpc.jwtsecret=/jwtsecret
      --rollup.sequencerhttp="$BEDROCK_SEQUENCER_HTTP"
      --rollup.disabletxpoolgossip=true
      --port="${PORT__OP_GETH_P2P:-39393}"
      --discovery.port="${PORT__OP_GETH_P2P:-39393}"
      --snapshot=true
      --verbosity=3
      --history.transactions=0
      --rollup.historicalrpc=${OP_GETH__HISTORICAL_RPC:-https://sequencer.alfajores.celo-testnet.org}
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.op-celo-alfajores-stripprefix.stripprefix.prefixes=/op-celo-alfajores"
      - "traefik.http.services.op-celo-alfajores.loadbalancer.server.port=8545"
      - "traefik.http.routers.op-celo-alfajores.entrypoints=websecure"
      - "traefik.http.routers.op-celo-alfajores.tls.certresolver=myresolver"
      - "traefik.http.routers.op-celo-alfajores.rule=Host(`$DOMAIN`) && PathPrefix(`/op-celo-alfajores`)"
      - "traefik.http.routers.op-celo-alfajores.middlewares=op-celo-alfajores-stripprefix, ipwhitelist"
    

  op-celo-alfajores-fullnode-node:
    image: us-west1-docker.pkg.dev/devopsre/celo-blockchain-public/op-node:celo-v2.0.0-rc4
    depends_on:
      - op-celo-alfajores-fullnode
    expose:
      - 8545     # RPC
      - 39395     # P2P TCP
      - 39395/udp # P2P UDP
      - 7300     # metrics
      - 6060     # pprof
    networks:
      - chains
    ports:
      - "39395:39395"
      - "39395:39395/udp"
    environment:
      - HEALTHCHECK__REFERENCE_RPC_PROVIDER=https://alfajores-forno.celo-testnet.org
      - OP_NODE_P2P=39395
      - OP_NODE_P2P_STATIC=/ip4/35.197.25.52/tcp/9222/p2p/16Uiu2HAmQEdyLRSAVZDr5SqbJ1RnKmNDhtQJcEKmemrVxe4FxKwR,/ip4/34.105.22.4/tcp/9222/p2p/16Uiu2HAm1SZBDSugT5MMu7vBY8auDgfZFNhoDeXPLc9Me5FsAxwT,/ip4/34.83.209.168/tcp/9222/p2p/16Uiu2HAmGJAiUX6HLSo4nLh8T984qxzokwL23cVsYuNZy2SrK7C6,/ip4/34.83.214.149/tcp/9222/p2p/16Uiu2HAmAko2Kr3eAjM7tnshtEhYrxQYfKUvN2kwiygeFoBAoi8S,/ip4/34.169.5.52/tcp/9222/p2p/16Uiu2HAmKc6YKHzYgsjBDaj36uAufxpgZFgrzDqVBt6zTPwdhhJD
      - OP_NODE_ALTDA_ENABLED=true
      - OP_NODE_ALTDA_DA_SERVICE=true
      - OP_NODE_ALTDA_VERIFY_ON_READ=false
      - OP_NODE_ALTDA_DA_SERVER=https://eigenda-proxy.alfajores.celo-testnet.org
    command: >
      op-node
      --l1="${OP_CELO_ALFAJORES_HOLESKY_RPC:-https://ethereum-holesky-rpc.publicnode.com}"
      --l2=http://op-celo-alfajores-fullnode:8551
      --rpc.addr=0.0.0.0
      --rpc.port=9545
      --l2.jwt-secret=/jwtsecret
      --l1.trustrpc
      --l1.rpckind=basic
      --l1.beacon="${OP_CELO_ALFAJORES_HOLESKY_BEACON_REST:-https://ethereum-holesky-beacon-api.publicnode.com}"
      --metrics.enabled
      --metrics.addr=0.0.0.0
      --metrics.port=7300
      --syncmode=execution-layer
      --p2p.priv.path=/shared/op-node_p2p_priv.txt
      --network=alfajores
      --rollup.load-protocol-versions=true
      --rollup.halt=major
    restart: always
    volumes:
      - .jwtsecret:/jwtsecret
    stop_grace_period: 30s

volumes:
  op-celo-alfajores-fullnode:

    
