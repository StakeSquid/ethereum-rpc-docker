services:
  taiko-hekla:
    image: us-docker.pkg.dev/evmchain/images/taiko-geth:${TAIKO_HEKLA_GETH_VERSION:-v1.12.0}
    restart: unless-stopped
    #pull_policy: always
    stop_grace_period: 3m
    volumes:
      - taiko-hekla:/data/taiko-geth
    expose:
      - 6060
      - 8545
      - 8551
    ports:
      - "50213:50213"
      - "50213:50213/udp"
    command: |
      --taiko
      --networkid 167009
      --gcmode full
      --datadir /data/taiko-geth
      --metrics
      --metrics.addr "0.0.0.0"
      --bootnodes "enode://1733a899719c64edc8ad6818598b6b9aa41889297a7ee7b9cbf3e610d4df2e207b0e04fd40060a36f020116ab5ad451201e448fc224cd38b0a0d5fcbb1d2c812@34.126.109.163:30303,enode://3c7e00eff6a98f5d49084db988b9bee9cab3338ee809d88e41318dc7ea7fb67ab8e8a923e4a9f193fecd7698ef92c0977e07ac850e10777bdd11cc25045d63bf@35.198.236.33:30303,enode://eb5079aae185d5d8afa01bfd2d349da5b476609aced2b57c90142556cf0ee4a152bcdd724627a7de97adfc2a68af5742a8f58781366e6a857d4bde98de6fe986@34.66.210.65:30303,enode://2294f526cbb7faa778192289c252307420532191438ce821d3c50232e019a797bda8c8f8541de0847e953bb03096123856935e32294de9814d15d120131499ba@34.72.186.213:30303"
      --authrpc.addr "0.0.0.0"
      --authrpc.vhosts "*"
      --http
      --http.api admin,debug,eth,net,web3,txpool,taiko
      --http.addr "0.0.0.0"
      --http.vhosts "*"
      --ws
      --ws.api debug,eth,net,web3,txpool,taiko
      --ws.addr "0.0.0.0"
      --ws.port 8545
      --ws.origins "*"
      --gpo.defaultprice "10000000"
      --port 50213
      --discovery.port 50213
      --maxpeers 50
      --maxpendpeers 0
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.taiko-hekla-stripprefix.stripprefix.prefixes=/taiko-hekla"
      - "traefik.http.services.taiko-hekla.loadbalancer.server.port=8545"
      - "traefik.http.routers.taiko-hekla.entrypoints=websecure"
      - "traefik.http.routers.taiko-hekla.tls.certresolver=myresolver"
      - "traefik.http.routers.taiko-hekla.rule=Host(`$DOMAIN`) && PathPrefix(`/taiko-hekla`)"
      - "traefik.http.routers.taiko-hekla.middlewares=taiko-hekla-stripprefix, ipwhitelist"
    networks:
      - chains

  taiko-hekla-client-driver:
    image: us-docker.pkg.dev/evmchain/images/taiko-client:${TAIKO_HEKLA_CLIENT_VERSION:-taiko-alethia-client-v0.43.2}
    restart: unless-stopped
    depends_on:
      - taiko-hekla
    environment:
      - "TAIKO_L1_ADDRESS=0x79C9109b764609df928d16fC4a91e9081F7e87DB"
      - "TAIKO_TOKEN_L1_ADDRESS=0x6490E12d480549D333499236fF2Ba6676C296011"
      - "ASSIGNMENT_HOOK_L1_ADDRESS=0x9e640a6aadf4f664CF467B795c31332f44AcBe6c"
      - "TAIKO_L2_ADDRESS=0x1670090000000000000000000000000000010001"
      - "L1_ENDPOINT_HTTP=${TAIKO_HOLESKY_EXECUTION_RPC}"
      - "L1_ENDPOINT_WS=${TAIKO_HOLESKY_EXECUTION_WS}"
      - "L1_BEACON_HTTP=${TAIKO_HOLESKY_BEACON_REST}"
      - "L2_CHECKPOINT_SYNC_RPC=https://rpc.hekla.taiko.xyz"
      - "L2_GETH_RPC=ws://taiko-hekla:8545"
      - "L2_GETH_AUTH=http://taiko-hekla:8551"
    volumes:
      - taiko-hekla:/data/taiko-geth
      - ./taiko/script:/script
    entrypoint:
      - /bin/sh
      - -c
      - "/script/start-driver.sh"
    networks:
      - chains
      
volumes:
  taiko-hekla:
